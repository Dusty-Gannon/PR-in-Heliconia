---
title: "Appendix S3: Testing for generality of pollinator recognition in *Heliconia* - Aviary experiments"
author: "Gannon et al."
header-includes:
  \usepackage{setspace}
  \onehalfspacing
  \usepackage{bm}
bibliography: /Users/dusty/Documents/zotero_library.bib
output: pdf_document
---

\subsection{Setup}
```{r setup, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# required packages
    require(ggplot2)
    require(rstan)
    require(loo)
    require(gridExtra)

# user-defined functions
    post.mode <- function(v){
      q <- which.max(density(v)$y)
      return(density(v)$x[q])
    }

# functions to turn time of day into "hours since midnight"
    hours <- function(x){
        substr(x, 1, nchar(x)-2)
    }

    minutes <- function(x){
      substr(x, nchar(x)-2+1, nchar(x))
    }

```

\subsubsection{Data processing}

```{r data, eval=FALSE}

  av <- read.csv("~/aviaries_data.csv", header = T, as.is = T)

  av <- av[with(av, order(Species, Plant, Experiment)), ]
  

  av$f.species <- as.factor(av$Species)
  av$f.trtmnt <- factor(av$Treatment, levels = c("HP", "RTAH", "GREH"))
  
# Transform hand-pollination time into unit-
#  scale measure of hours after midnight
  av$hrs_postmidn <- scale(as.integer(hours(av$HP_time)) + 
                             as.numeric(minutes(av$HP_time))/60)
  
```

\subsection{Model}

  We assume that pollen tube counts, $y_{i} \in \mathbb{R}^+$, $i=1,2,...,N$, are draws from Poisson distributions with rate parameters $\lambda_{i}$. We model the rate parameter as
  
$$
\begin{split}
\log \lambda_{i} = {\bf X}_{i*}{\bm \beta} + \gamma_{p,s}^{(i)};\\
\\
\gamma_{1,s}, \gamma_{2,s},...,\gamma_{P_s,s} \overset{iid}{\sim} \mathcal{N}(0, \sigma_s^2)
\end{split}
$$
where $P_s$ is the total number of plants of species $s$ used in experiments, $S$ is the number of species tested, and ${\bf X}_{i*}$ is the $i^{\text{th}}$ row of the model matrix $\bf X$. We use the superscript $(i)$ to be clear that the plant $p$ and species $s$ are associated with the $i^\text{th}$ observation. The model matrix ${\bf X}$ includes a control variable for the time of day at which an experiment took place, as environmental factors that covary with the time of day (e.g. heat, relative humidity) can affect stigmatic receptivity [@dafni2000] and pollen viability [@hedhly2003], and an interaction between the treatment and plant species. In these experiments, we had 3 treatments (hand pollination only, hand pollination followed by a visit from a clean, short-billed hummingbird, and hand pollination followed by a visit from a long-billed hummingbird), and $S=4$ plant species. Thus, $\bf X$ is rank $K=S\times P + 1$.

We placed weakly informative priors on the elements of the $K$-dimensional regression parameter vector $\bm \beta$, assuming ${\bm \beta}_K \sim \mathcal{N}({\bf 0},\ 1.5\cdot {\bf I}_K)$, where ${\bf I}_K$ is the rank $K$ identity matrix, and the species-specific scale parameters such that $\sigma_s \sim \text{half-Cauchy}(0,2)$ for each $s \in \{1,2,...,S\}$. This structure allows us to account for repeated experiments on individual plants without assuming all plant effects are i.i.d. random variables, but instead that plant effects are i.i.d. within a species (see main text and Appendices S1 and S2 for more details on prior justification and experimental procedures).

 
  
\subsubsection{Stan model code}


```{stan output.var="poisson_regVaryInts_pl", eval=FALSE}

  data{
  
    int N;         //number of observations
    int K;         //number of regressions parameters
    int P;         //number of unique plants sampled (i.e. number of intercepts)
    int S;         //number of species in the analysis
    int pl[N];  //index for the plant in experiment i
    int sp[N];     //index for the plant species in experiment i
    int<lower=0> y[N];  //observations
    matrix[N,K] X;      //design matrix
  
  }
  
  parameters{
  
    vector[K] beta;            //vector of regression parameters
    real gamma_raw[P];         //individual plant effects before scaling
    real<lower=0> sigma[S];    //sd of plant effects, unique across species
  
  }
  
  transformed parameters{
  
    real<lower=0> lambda[N];  //rate parameter for the nth obs.

    for(n in 1:N){
      lambda[n] = exp(X[n,]*beta + gamma_raw[pl[n]]*sigma[sp[n]]);
    }
  
  }
  
  model{
  
    //priors
    beta ~ normal(0,1.5);
    for(s in 1:S){
      sigma[s] ~ cauchy(0,2);
    }
    for(p in 1:P){
      gamma_raw[p] ~ normal(0,1);
    }
    
    //model
    for(n in 1:N){
      y[n] ~ poisson(lambda[n]);
    }
    
  }

  generated quantities{
  
    vector[N] loglik;
    int y_rep[N];
    
    for(n in 1:N){
      loglik[n] = poisson_lpmf(y[n] | lambda[n]);
      y_rep[n] = poisson_rng(lambda[n]);
    }
  
  }

```
  
\subsubsection{Fit the model}

```{r run model 2, eval=FALSE}

#Define data as in model specification
  N <- dim(av)[1]
  P <- length(unique(av$Plant))
  S <- length(unique(av$Species))
  y <- av$Tube_Count
  X <- model.matrix(~ hrs_post_midn + f.species*f.trtmnt -1, data = av)
  K <- dim(X)[2]
  plant <- as.integer(factor(av$Plant, levels = unique(av$Plant)))
  sp <- as.integer(factor(av$Species, levels = unique(av$Species)))
  
#compile data into list
  mod.data <- list(N=N, K=K, P=P, S=S, y=y, X=X, pl=plant, sp=sp)
  
# sampling statement
  mfit <- sampling(poisson_regVaryInts_pl, data=mod.data, chains=2, 
                   control=list(adapt_delta=0.9))
  
  
# looic and other model assessments
  
  loglik <- extract_log_lik(mfit, "loglik", merge_chains = FALSE)
  reff <- relative_eff(exp(loglik))
  loo_mfit <- loo(loglik, r_eff = reff)


```




```{r tube rates, echo=FALSE, eval=FALSE}

  beta <- as.data.frame(extract(mfit, pars="beta"))
  beta_prime <- t(beta)

# function to get means on pollen tube scale

  pt_mean <- function(v, h){
    exp(h%*%v)
  }
  

# create a dummy model matrix
  
    trtmnts <- c("HP", "RTAH", "GREH")
    spp <- rep(unique(av$Species), each=length(trtmnts))
    newdat <- data.frame(as.factor(spp), factor(trtmnts, levels = trtmnts))
    newdat$hrs_postmidn <- rep(0, nrow(newdat))
    names(newdat) <- c("f.species", "f.trtmnt", "hrs_postmidn")
    
  X_new <- model.matrix(~hrs_post_midn + f.species*f.trtmnt -1, data = newdat)
  
  
  df_means <- data.frame(apply(beta_prime, 2, pt_mean, h=X_new[1,]))
  
  for(i in 2:nrow(X_new)){
    df_means <- cbind(df_means, data.frame(apply(beta_prime, 2, pt_mean, h=X_new[i,])))
  }
  
  names(df_means) <- c("hirs_hp", "hirs_rtah", "hirs_greh", "ros_hp", "ros_rtah", "ros_greh",
                       "tor_hp", "tor_rtah", "tor_greh", "wag_hp", "wag_rtah","wag_greh")
  
  sp <- c("H. hirsuta", "H. rostrata", "H. tortuosa", "H. wagneriana")
  
  post.means <- apply(df_means, 2, mean)
  post.quants <- apply(df_means, 2, quantile, probs=c(0.025,0.1, 0.9,0.975))
  
  df_plot_means <- as.data.frame(cbind(post.means, t(post.quants)))
  df_plot_means$trt <- rep(trtmnts, length(unique(spp)))
  names(df_plot_means) <- c("mean", "low", "medlow", "medhigh", "high", "trt")
  df_plot_means$trt <- factor(df_plot_means$trt, levels = c("HP", "RTAH", "GREH"))
  
  greh.col <- rgb(42,157,143, maxColorValue = 255)
  rtah.col <- rgb(255,107,107, maxColorValue = 255)
  
  mean_theme <- theme(panel.background = element_blank(),
                      axis.line = element_line(colour = "darkgrey"),
                      legend.position = "none",
                      axis.text = element_text(size = 12, color="black"),
                      plot.title = element_text(face = "italic"))
  
  hir <- ggplot(data = df_plot_means[1:3,], aes(x=trt, y=mean))+
    geom_errorbar(ymin=df_plot_means$low[1:3], ymax=df_plot_means$high[1:3],
                  size=0.5, width=0)+
    geom_errorbar(ymin=df_plot_means$medlow[1:3], ymax=df_plot_means$medhigh[1:3],
                  size=1.6, width=0)+
    geom_point(size=5, color="white")+
    geom_point(size=4, color="black")+
    geom_point(size=3.5, aes(color=trt))+
    ylim(c(0,3))+
    scale_color_manual(values = c("black", rtah.col, greh.col))+
    mean_theme+
    xlab("")+
    ylab("")+
    ggtitle("H. hirsuta")
  
  
  ros <- ggplot(data = df_plot_means[4:6,], aes(x=trt, y=mean))+
    geom_errorbar(ymin=df_plot_means$low[4:6], ymax=df_plot_means$high[4:6],
                  size=0.5, width=0)+
    geom_errorbar(ymin=df_plot_means$medlow[4:6], ymax=df_plot_means$medhigh[4:6],
                  size=1.6, width=0)+
    geom_point(size=5, color="white")+
    geom_point(size=4, color="black")+
    geom_point(size=3.5, aes(color=trt))+
    scale_color_manual(values = c("black", rtah.col, greh.col))+
    mean_theme+
    theme(axis.text.x=element_blank())+
    scale_y_continuous(breaks = c(0,1,2), limits = c(0,2))+
    xlab("")+
    ylab("")+
    ggtitle("H. rostrata")
  
 
  tor <- ggplot(data = df_plot_means[7:9,], aes(x=trt, y=mean))+
    geom_errorbar(ymin=df_plot_means$low[7:9], ymax=df_plot_means$high[7:9],
                  size=0.5, width=0)+
    geom_errorbar(ymin=df_plot_means$medlow[7:9], ymax=df_plot_means$medhigh[7:9],
                  size=1.6, width=0)+
    geom_point(size=5, color="white")+
    geom_point(size=4, color="black")+
    geom_point(size=3.5, aes(color=trt))+
    ylim(c(0,3))+
    scale_color_manual(values = c("black", rtah.col, greh.col))+
    mean_theme+
    theme(axis.text.x=element_blank())+
    xlab("")+
    ylab("")+
    ggtitle("H. tortuosa")
  
  wag <- ggplot(data = df_plot_means[10:12,], aes(x=trt, y=mean))+
    geom_errorbar(ymin=df_plot_means$low[10:12], ymax=df_plot_means$high[10:12],
                  size=0.5, width=0)+
    geom_errorbar(ymin=df_plot_means$medlow[10:12], ymax=df_plot_means$medhigh[10:12],
                  size=1.6, width=0)+
    geom_point(size=5, color="white")+
    geom_point(size=4, color="black")+
    geom_point(size=3.5, aes(color=trt))+
    ylim(c(0,3))+
    scale_color_manual(values = c("black", rtah.col, greh.col))+
    mean_theme+
    xlab("")+
    ylab("")+
    ggtitle("H. wagneriana")
  
 png(filename = "~/Documents/Heliconia/Analyses/PR/PR_aviaries/means_plot.png", units = "px",
      height = 2200, width = 1800, res = 300)
   grid.arrange(tor,ros,hir,wag, nrow=2,ncol=2)
 dev.off()
  
  
```  


\subsection{References}





