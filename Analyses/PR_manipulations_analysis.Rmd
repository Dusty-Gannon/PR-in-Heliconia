---
title: "Appendix S4: Testing for generality of pollinator recognition in *Heliconia* - Nectar extraction analysis"
author: "D. G. Gannon, A. S. Hadley, U. G. Kormann, F. A. Jones, and M. G. Betts"
output: pdf_document
header-includes:
  \usepackage{setspace}
  \onehalfspacing
  \usepackage{bm}
bibliography: /Users/dusty/Documents/zotero_library.bib
---

**Setup**


```{r knit setup, echo=TRUE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)

  require(rstan)
  require(loo)
  require(dplyr)
  require(gridExtra)
  require(grid)
  require(kableExtra)

```

\subsubsection{User-defined functions}
```{r functions}

    post.mode <- function(v){
      q <- which.max(density(v)$y)
      return(density(v)$x[q])
    }

    hours <- function(x){
        substr(x, 1, nchar(x)-2)
    }

    minutes <- function(x){
      substr(x, nchar(x)-2+1, nchar(x))
    }


```

\subsubsection{Data preparation}

```{r load data}

# read in data
  nectar <- read.csv(file = "~/Documents/Heliconia/Data/PR/nectar_experiments_all.csv", 
                     header=T, as.is = T)

# remove hirsuta experiments (not enough)
  nectar <- nectar[-which(nectar$Species == "H.hirsuta"), ]
  
# remove observations without complete information
  nectar <- nectar[-which(is.na(nectar$HP_time)), ]

# remove cases in which liquid removed was not likely to be nectar
  nectar$Brix2 <- nectar$Brix
  nectar$Brix2[which(nectar$Brix2 == ">32")] <- "32" # replace entries of >32 with 32
  nectar <- nectar[-which(nectar$Brix2 < 14.1),]
  
  nectar$Nectar2 <- nectar$Nectar_Out
  nectar$Nectar2[which(is.na(nectar$Nectar2))] <- 0
  nectar <- nectar[-which(nectar$Nectar2 > 30 & nectar$Species!="H.rostrata"), ]

# create treatments for whether we pollinated before or after
  nectar$Treatment[which(nectar$Pollen_added_after_visit == 1)] <- "NEHP"
  
#create factors for species and treatment
  nectar$f.species <- factor(nectar$Species)
  nectar$f.trt <- factor(nectar$Treatment, levels = c("HP", "PM", "HPNE", "NEHP"))
  
  
```

\subsection{Summary}

  We analyze pollen tube data from nectar extraction experiments in a similar way to how we analyzed the data from the aviary experiments (see Appendix S2 for more details). In the data processing stage, we removed observations from experiments in which our nectar removal experiments were likely unsuccessful. We deemed experiments likely to be unsuccessful if the liquid removed was dilute and largely water from the bract taken up after the perianth was perforated by the pipette tip. In an independent dataset, the minimum Brix\% measured was 14.1\% (K.G. Leimburger *unpublished data*), and the volume of nectar found in a flower was rarely greater than 60 $\mu$L for *H. rostrata* and 30 for *H. tortuosa* and *H. wagneriana*. We therefore removed observations for which the volume was greater than these thresholds and/or the Brix\% was below 14.1 before fitting the model.
  
  
\subsection{Model}
  
  We assume pollen tube counts from individual styles $y_1, y_2, ... , y_n \in \mathbb{N}^+$ are distributed $\text{Poisson}(\lambda_i)$, $i = 1,2,...,N$, where $N$ is the total number of observations. The $N$-dimensional vector of mean paramaters ${\bm \lambda}$ is modeled as a regression
  
$$
\begin{split}
\log \lambda_{i} = {\bf X}_{i*}{\bm \beta} + \gamma_{p,s}^{(i)};\ p=1,2,...,P_s;\ s=1,2,...,S\\
\\
\gamma_{1,s},\gamma_{2,s},...,\gamma_{P_s,s} \sim \text{Normal}(0, \sigma_s^2);\ s=1,2,...,S,
\end{split}
$$
  
where $\bm \beta$ is a $K$-dimensional vector with $K$ as the number of covariates, $P_s$ is the total number of plants of species $s$ used in experiments, $S$ is the number of species tested, and ${\bf X}_{i*}$ is the $i^{\text{th}}$ row of the model matrix $\bf X$. The effects $\gamma_{p,s}$ are effects to account for repeated measures on a given plant within species $s$. We placed weakly informative priors on the species-specific scale parameters such that $\sigma_s \sim \text{half-Cauchy}(0,2)$ for each $s \in \{1,2,...,S\}$. This structure allows us to account for repeated experiments on individual plants without assuming all plant effects are i.i.d. random variables, but instead that plant effects are i.i.d. within a species.


For priors, we assume the regression coefficients are independent and normally distributed with

$$
{\bm \beta} \sim \mathcal{N}\bigg({\bf 0}_{K},\ 1.5\cdot{\bf I}_{(K\times K)}\bigg)
$$
where $I$ is the identity matrix. We placed weakly informative priors on the species-specific scale parameters such that $\sigma_s \sim \text{half-Cauchy}(0,2)$ for each $s \in \{1,2,...,S\}$. This structure allows us to account for repeated experiments on individual plants without assuming all plant effects are i.i.d. random variables, but instead that plant effects are i.i.d. within a species.
  
\subsubsection{Stan model code}

```{stan output.var="poisson_reg_VarInts_pl", eval=FALSE}

  data{
  
    int<lower=0> N;       //number of observations
    int<lower=0> K;       //number of covariates in regression model
    int<lower=0> P;       //number of individual plants used in experiments
    int<lower=0> S;       //number of species in the analysis
    
    int<lower=0> sp[N];   //index for the species
    int<lower=0> pl[N];   //index for the plant
    
    matrix[N,K] X;        //model matrix
    
    int<lower=0> y[N];    //pollen tube counts
  
  }
  
  
  parameters{
  
    vector[K] beta;             //lower level regression parameters
    real gamma_raw[P];          //plant level effects
    real<lower=0> sigma[S];     //species-specific scale parameters for plant effects
  
  }
  
  
  transformed parameters{
  
    real<lower=0> lambda[N];       //means

    for(n in 1:N){
      lambda[n] = exp(X[n,]*beta + sigma[sp[n]]*gamma_raw[pl[n]]);
    }
    
  }
  
  
  model{
  
    //priors
    
    beta ~ normal(0,1.5);

    for(s in 1:S){
      sigma[s] ~ cauchy(0,2);
    }
    
    //model
    
    for(p in 1:P){
     gamma_raw[p] ~ normal(0,1);
    }
    
    for(n in 1:N){
      y[n] ~ poisson(lambda[n]);
    }
    
  }
  
  generated quantities{
  
    vector[N] loglik;
    vector[N] y_rep;
    
    for(n in 1:N){
      loglik[n] = poisson_lpmf(y[n] | lambda[n]);
    }
    
    for(n in 1:N){
      y_rep[n] = poisson_rng(lambda[n]);
    }
  
  }

```

\subsubsection{Fit the model} 
```{r run model, eval=FALSE}

  N <- dim(nectar)[1]
  
  X <- model.matrix(~f.trt*f.species, data = nectar)
  K <- dim(X)[2]

  S <- length(unique(nectar$Species))
  sp <- as.integer(factor(nectar$Species))
  
  P <- length(unique(nectar$Plant))
  pl <- as.integer(factor(nectar$Plant))
  
  y <- nectar$Tube_Count
  
  mod.data <- list(N=N, X=X, K=K, S=S, sp=sp, P=P, pl=pl, y=y)
  
  
# fit the model
  
  mfit <- sampling(poisson_reg_VarInts_pl, data=mod.data, control=list(adapt_delta=0.85))
  

```


```{r eval=FALSE, echo=FALSE}
save(mfit, mfitm2, mod.data, modm2.data, file = "~/Documents/Heliconia/Analyses/PR/PR_HPvsHPNE_short/model_fit.RData")
```


```{r, echo=FALSE}
load("~/Documents/Heliconia/Analyses/PR/PR_HPvsHPNE_short/model_fit.RData")
```


Model assessments:
```{r model assessment, warning=FALSE}

  loglik <- extract_log_lik(mfit, parameter_name = "loglik", merge_chains = FALSE)
  reff <- relative_eff(exp(loglik))
  
  modloo <- loo(loglik, r_eff = reff)
  
# check for influential observations
  odd.obs <- pareto_k_ids(modloo, threshold = 0.7)
  nectar[odd.obs,]

```

$~$ 

Two observations are influential to the inference. We choose *not* to remove these from the analysis because they are not incorrect, but caution readers in their interpretations of the results of nectar removal experiments with *H. wagneriana*. The results after excluding these two observations are shown in Figure S2.


```{r run model without influential obs, echo=FALSE, eval=FALSE}

  nectarm2 <- nectar[-odd.obs,]
  
  Nm2 <- dim(nectarm2)[1]
  
  Xm2 <- model.matrix(~f.trt*f.species, data = nectarm2)
  Km2 <- dim(Xm2)[2]

  Sm2 <- length(unique(nectarm2$Species))
  spm2 <- as.integer(factor(nectarm2$Species))
  
  Pm2 <- length(unique(nectarm2$Plant))
  plm2 <- as.integer(factor(nectarm2$Plant))
  
  ym2 <- nectarm2$Tube_Count
  
  modm2.data <- list(N=Nm2, X=Xm2, K=Km2, S=Sm2, sp=spm2, P=Pm2, pl=plm2, y=ym2)
  
  
# fit the model
  
  mfitm2 <- sampling(poisson_reg_VarInts_pl, data=modm2.data, control=list(adapt_delta=0.85))
  

```

**********


```{r supp fig, echo=FALSE, fig.width=4, fig.height=8}

  Xm2 <- modm2.data[["X"]]
  nectarm2 <- nectar[-odd.obs,]
  beta_post <- as.matrix(as.data.frame(extract(mfitm2, pars="beta")))
  
# create vectors for linear predictors
  hpros <- as.double(Xm2[which(nectarm2$Species == "H.rostrata" & 
                               nectarm2$f.trt == "HP")[1], ])
  bmros <- as.double(Xm2[which(nectarm2$Species == "H.rostrata" & 
                               nectarm2$f.trt == "PM")[1], ])
  hpneros <- as.double(Xm2[which(nectarm2$Species == "H.rostrata" & 
                               nectarm2$f.trt == "HPNE")[1], ])
  nehpros <- as.double(Xm2[which(nectarm2$Species == "H.rostrata" & 
                               nectarm2$f.trt == "NEHP")[1], ])
  hptor <- as.double(Xm2[which(nectarm2$Species == "H.tortuosa" & 
                               nectarm2$f.trt == "HP")[1], ])
  bmtor <- as.double(Xm2[which(nectarm2$Species == "H.tortuosa" & 
                               nectarm2$f.trt == "PM")[1], ])
  hpnetor <- as.double(Xm2[which(nectarm2$Species == "H.tortuosa" & 
                               nectarm2$f.trt == "HPNE")[1], ])
  nehptor <- as.double(Xm2[which(nectarm2$Species == "H.tortuosa" & 
                               nectarm2$f.trt == "NEHP")[1], ])
  hpwag <- as.double(Xm2[which(nectarm2$Species == "H.wagneriana" & 
                               nectarm2$f.trt == "HP")[1], ])
  bmwag <- as.double(Xm2[which(nectarm2$Species == "H.wagneriana" & 
                               nectarm2$f.trt == "PM")[1], ])
  hpnewag <- as.double(Xm2[which(nectarm2$Species == "H.wagneriana" & 
                               nectarm2$f.trt == "HPNE")[1], ])
  nehpwag <- as.double(Xm2[which(nectarm2$Species == "H.wagneriana" & 
                               nectarm2$f.trt == "NEHP")[1], ])

  
# Create posterior means and CIs
  species <- rep(c("H. rostrata", "H. tortuosa", "H. wagneriana"), each=4)
  trt <- rep(c("HP", "HP + \npipette", "HP + \nnectar \nextraction", "Nectar \nextraction + \nHP"), 3)
  X.unique <- rbind(hpros, bmros, hpneros, nehpros,
                    hptor, bmtor, hpnetor, nehptor,
                    hpwag, bmwag, hpnewag, nehpwag)
  
  loglambda_post <- beta_post%*%t(X.unique)
  lambda_post <- apply(loglambda_post, 2, exp)
  
  df.plot <- data.frame(species=species, trt=trt,
                          estim=apply(lambda_post, 2, mean),
                          low=apply(lambda_post,2,quantile, probs=0.025),
                          medlow=apply(lambda_post,2,quantile, probs=0.1),
                          medhigh=apply(lambda_post,2,quantile, probs=0.9),
                          high=apply(lambda_post,2,quantile, probs=0.975))
  df.plot$trt <- factor(df.plot$trt, 
                        levels = c("HP", "HP + \npipette", "HP + \nnectar \nextraction", "Nectar \nextraction + \nHP"))
  
  plottheme <- theme_bw()+
    theme(plot.title = element_text(face="italic", size = 16),
          axis.text = element_text(colour = "black", size = 12),
          axis.title = element_text(size = 16),)
  
  xtitle <- textGrob("Pollen tubes per style", rot = 90, gp=gpar(fontsize=20))
  
  ros <- ggplot(data = df.plot[1:4,], aes(x=trt, y=estim))+
    geom_errorbar(ymin=df.plot$low[1:4], ymax=df.plot$high[1:4], width=0)+
    geom_errorbar(ymin=df.plot$medlow[1:4], ymax=df.plot$medhigh[1:4], width=0, size=1.2)+
    geom_point(size=3.5, color="white")+
    geom_point(size=3)+
    ylim(c(0,1.5))+
    plottheme +
    theme(axis.text.x = element_text(colour = "white"))+
    ylab("")+
    xlab("")+
    ggtitle("H. rostrata")
  
  tor <- ggplot(data = df.plot[5:8,], aes(x=trt, y=estim))+
    geom_errorbar(ymin=df.plot$low[5:8], ymax=df.plot$high[5:8], width=0)+
    geom_errorbar(ymin=df.plot$medlow[5:8], ymax=df.plot$medhigh[5:8], width=0, size=1.2)+
    geom_point(size=3.5, color="white")+
    geom_point(size=3)+
    ylim(c(0,1.5))+
    plottheme +
    theme(axis.text.x = element_text(colour = "white"))+
    ylab("")+
    xlab("")+
    ggtitle("H. tortuosa")
  
  wag <- ggplot(data = df.plot[9:12,], aes(x=trt, y=estim))+
    geom_errorbar(ymin=df.plot$low[9:12], ymax=df.plot$high[9:12], width=0)+
    geom_errorbar(ymin=df.plot$medlow[9:12], ymax=df.plot$medhigh[9:12], width=0, size=1.2)+
    geom_point(size=3.5, color="white")+
    geom_point(size=3)+
    ylim(c(0,3.5))+
    plottheme +
    ylab("")+
    xlab("")+
    ggtitle("H. wagneriana")+
    scale_y_continuous(breaks=c(0,1,2,3), labels = c("0.0", "1.0", "2.0", "3.0"), 
                       limits = c(0,3.5))
  
  lo <- rbind(c(1,2,2,2,2,2),
              c(1,3,3,3,3,3),
              c(1,4,4,4,4,4))
  
  #png(filename = "~/Documents/Heliconia/Analyses/PR/PR_HPvsHPNE_short/means_plot.png", width = 1800, height = 3000,
   #   res = 300)
  grid.arrange(xtitle, ros, tor, wag, layout_matrix=lo)
  #dev.off()

```

**Figure S2**: Posterior pollen tube rates based on a model fit to the dataset without the two influential observations.


$~$

```{r fig 3 main text, echo=FALSE, eval=FALSE}

  X <- mod.data[["X"]]
  beta_post <- as.matrix(as.data.frame(extract(mfit, pars="beta")))
  
# create vectors for linear predictors
  hpros <- as.double(X[which(nectar$Species == "H.rostrata" & 
                               nectar$f.trt == "HP")[1], ])
  bmros <- as.double(X[which(nectar$Species == "H.rostrata" & 
                               nectar$f.trt == "PM")[1], ])
  hpneros <- as.double(X[which(nectar$Species == "H.rostrata" & 
                               nectar$f.trt == "HPNE")[1], ])
  nehpros <- as.double(X[which(nectar$Species == "H.rostrata" & 
                               nectar$f.trt == "NEHP")[1], ])
  hptor <- as.double(X[which(nectar$Species == "H.tortuosa" & 
                               nectar$f.trt == "HP")[1], ])
  bmtor <- as.double(X[which(nectar$Species == "H.tortuosa" & 
                               nectar$f.trt == "PM")[1], ])
  hpnetor <- as.double(X[which(nectar$Species == "H.tortuosa" & 
                               nectar$f.trt == "HPNE")[1], ])
  nehptor <- as.double(X[which(nectar$Species == "H.tortuosa" & 
                               nectar$f.trt == "NEHP")[1], ])
  hpwag <- as.double(X[which(nectar$Species == "H.wagneriana" & 
                               nectar$f.trt == "HP")[1], ])
  bmwag <- as.double(X[which(nectar$Species == "H.wagneriana" & 
                               nectar$f.trt == "PM")[1], ])
  hpnewag <- as.double(X[which(nectar$Species == "H.wagneriana" & 
                               nectar$f.trt == "HPNE")[1], ])
  nehpwag <- as.double(X[which(nectar$Species == "H.wagneriana" & 
                               nectar$f.trt == "NEHP")[1], ])

  
# Create posterior means and CIs
  species <- rep(c("H. rostrata", "H. tortuosa", "H. wagneriana"), each=4)
  trt <- rep(c("HP", "HP + \npipette", "HP + \nnectar \nextraction", "Nectar \nextraction + \nHP"), 3)
  X.unique <- rbind(hpros, bmros, hpneros, nehpros,
                    hptor, bmtor, hpnetor, nehptor,
                    hpwag, bmwag, hpnewag, nehpwag)
  
  loglambda_post <- beta_post%*%t(X.unique)
  lambda_post <- apply(loglambda_post, 2, exp)
  
  df.plot <- data.frame(species=species, trt=trt,
                          estim=apply(lambda_post, 2, mean),
                          low=apply(lambda_post,2,quantile, probs=0.025),
                          medlow=apply(lambda_post,2,quantile, probs=0.1),
                          medhigh=apply(lambda_post,2,quantile, probs=0.9),
                          high=apply(lambda_post,2,quantile, probs=0.975))
  df.plot$trt <- factor(df.plot$trt, 
                        levels = c("HP", "HP + \npipette", "HP + \nnectar \nextraction", "Nectar \nextraction + \nHP"))
  
  plottheme <- theme(panel.background = element_blank(),
                     axis.line = element_line(colour = "black"),
                     plot.title = element_text(face="italic", size = 16),
                     axis.text = element_text(colour = "black", size = 12),
                     axis.title = element_text(size = 16))
  
  xtitle <- textGrob("Pollen tubes per style", rot = 90, gp=gpar(fontsize=20))
  
  ros <- ggplot(data = df.plot[1:4,], aes(x=trt, y=estim))+
    geom_errorbar(ymin=df.plot$low[1:4], ymax=df.plot$high[1:4], width=0)+
    geom_errorbar(ymin=df.plot$medlow[1:4], ymax=df.plot$medhigh[1:4], width=0, size=1.2)+
    geom_point(size=3.5, color="white")+
    geom_point(size=3)+
    ylim(c(0,1.5))+
    plottheme +
    theme(axis.text.x = element_text(colour = "white"))+
    ylab("")+
    xlab("")+
    ggtitle("H. rostrata")
  
  tor <- ggplot(data = df.plot[5:8,], aes(x=trt, y=estim))+
    geom_errorbar(ymin=df.plot$low[5:8], ymax=df.plot$high[5:8], width=0)+
    geom_errorbar(ymin=df.plot$medlow[5:8], ymax=df.plot$medhigh[5:8], width=0, size=1.2)+
    geom_point(size=3.5, color="white")+
    geom_point(size=3)+
    ylim(c(0,1.5))+
    plottheme +
    theme(axis.text.x = element_text(colour = "white"))+
    ylab("")+
    xlab("")+
    ggtitle("H. tortuosa")
  
  wag <- ggplot(data = df.plot[9:12,], aes(x=trt, y=estim))+
    geom_errorbar(ymin=df.plot$low[9:12], ymax=df.plot$high[9:12], width=0)+
    geom_errorbar(ymin=df.plot$medlow[9:12], ymax=df.plot$medhigh[9:12], width=0, size=1.2)+
    geom_point(size=3.5, color="white")+
    geom_point(size=3)+
    ylim(c(0,3.5))+
    plottheme +
    ylab("")+
    xlab("")+
    ggtitle("H. wagneriana")+
    scale_y_continuous(breaks=c(0,1,2,3), labels = c("0.0", "1.0", "2.0", "3.0"), 
                       limits = c(0,3.5))
  
  lo <- rbind(c(1,2,2,2,2,2),
              c(1,3,3,3,3,3),
              c(1,4,4,4,4,4))
  
png(filename = "~/Documents/Heliconia/Analyses/PR/PR_HPvsHPNE_short/figure_3_means_plot.png", width = 1800, height = 3000,
      res = 300)
  grid.arrange(xtitle, ros, tor, wag, layout_matrix=lo)
dev.off()

```


```{r eval=FALSE, echo=FALSE}

  beta_post_full <- as.matrix(as.data.frame(extract(mfit, pars="beta")))
  X <- mod.data[["X"]]

  hpros_full <- as.double(X[which(nectar$Species == "H.rostrata" & 
                               nectar$f.trt == "HP")[1], ])
  nehpros_full <- as.double(X[which(nectar$Species == "H.rostrata" & 
                               nectar$f.trt == "NEHP")[1], ])
  hptor_full <- as.double(X[which(nectar$Species == "H.tortuosa" & 
                               nectar$f.trt == "HP")[1], ])
  nehptor_full <- as.double(X[which(nectar$Species == "H.tortuosa" & 
                               nectar$f.trt == "NEHP")[1], ])
  hpwag_full <- as.double(X[which(nectar$Species == "H.wagneriana" &
                                    nectar$f.trt == "HP")[1], ])
  nehpwag_full <- as.double(X[which(nectar$Species == "H.wagneriana" & 
                               nectar$f.trt == "NEHP")[1], ])
# H. rostrata
  mean(exp(as.double(beta_post_full%*%nehpros_full) - 
             as.double(beta_post_full%*%hpros_full)))
  quantile(exp(as.double(beta_post_full%*%nehpros_full) - 
             as.double(beta_post_full%*%hpros_full)), probs = c(0.025,0.975))
  
# H. tortuosa
  mean(exp(as.double(beta_post_full%*%nehptor_full) - 
             as.double(beta_post_full%*%hptor_full)))
  quantile(exp(as.double(beta_post_full%*%nehptor_full) - 
             as.double(beta_post_full%*%hptor_full)), probs = c(0.025,0.975)) 
  
 # H. wagneriana
  mean(exp(as.double(beta_post_full%*%nehpwag_full) - 
             as.double(beta_post_full%*%hpwag_full)))
  quantile(exp(as.double(beta_post_full%*%nehpwag_full) - 
             as.double(beta_post_full%*%hpwag_full)), probs = c(0.025,0.975))  

```












